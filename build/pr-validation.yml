trigger: none

pr: none

# pr:
#   autoCancel: true
#   branches:
#     include: ['master', 'main']

variables:
  - template: templates/globals.yml

jobs:
  - job: typecheck
    displayName: Typecheck

    pool:
      vmImage: 'ubuntu-18.04'

    steps:
      - template: templates/node.yml

      - script: npx tsc --noEmit
        displayName: tsc root

      - script: npx lerna exec --stream --no-bail --ignore=pyright-root -- tsc --noEmit
        displayName: tsc packages

      - script: npx gulp --tasks
        displayName: Check gulp

  - job: style
    displayName: Style
    pool:
      vmImage: 'ubuntu-18.04'

    steps:
      - template: templates/node.yml
        parameters:
          installAll: true

      - bash: git diff --exit-code --name-only
        displayName: Diff after npm install

      - script: npm run check
        displayName: npm run check

      - script: npm run createindices
        displayName: npm run createindices
        workingDirectory: packages/pylance-internal

      - bash: git diff --exit-code --name-only
        displayName: Diff after createindices

  - template: templates/test.yml
    parameters:
      name: pylance_internal
      workingDirectory: packages/pylance-internal
      dependsOn: typecheck

  - template: templates/test.yml
    parameters:
      name: pyright_internal
      workingDirectory: packages/pyright/packages/pyright-internal
      dependsOn: typecheck

  - template: templates/test.yml
    parameters:
      name: vscode_pylance
      workingDirectory: packages/vscode-pylance
      dependsOn: typecheck
      gui: true
